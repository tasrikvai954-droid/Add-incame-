<!-- Monetag SDK -->
<script src='//libtl.com/sdk.js' data-zone='9946269' data-sdk='show_9946269'></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const watchAdBtn = document.getElementById('watch-ad-btn');
        const startEarningBtn = document.getElementById('start-earning-btn');
        const withdrawBtn = document.getElementById('withdraw-btn');
        const withdrawForm = document.getElementById('withdraw-form');

        const DAILY_ADS_LIMIT = 50;
        const AD_REWARD = 0.02; // BDT per ad
        const MIN_WITHDRAW_AMOUNT = 100;

        if (!localStorage.getItem('earnings')) {
            localStorage.setItem('earnings', '0');
            localStorage.setItem('adsWatched', '0');
            localStorage.setItem('totalReferrals', '0');
        }

        function updateUI() {
            const earnings = parseFloat(localStorage.getItem('earnings'));
            const adsWatched = parseInt(localStorage.getItem('adsWatched'));

            document.getElementById('current-balance').textContent = `BDT ${earnings.toFixed(2)}`;
            document.getElementById('total-earnings').textContent = `BDT ${earnings.toFixed(2)}`;
            document.getElementById('ads-watched').textContent = adsWatched;
            document.getElementById('ad-progress-text').textContent = `Completed: ${adsWatched} / ${DAILY_ADS_LIMIT}`;
            document.getElementById('ad-progress-bar').style.width = `${(adsWatched / DAILY_ADS_LIMIT) * 100}%`;

            watchAdBtn.disabled = adsWatched >= DAILY_ADS_LIMIT;
        }

        watchAdBtn.addEventListener('click', () => {
            if (parseInt(localStorage.getItem('adsWatched')) >= DAILY_ADS_LIMIT) {
                tg.showAlert('আপনার দৈনিক বিজ্ঞাপনের সীমা পৌঁছে গেছে।');
                return;
            }

            watchAdBtn.disabled = true;

            // === Monetag Rewarded Popup ===
            if (typeof show_9946269 === 'function') {
                show_9946269('pop').then(() => {
                    let earnings = parseFloat(localStorage.getItem('earnings')) + AD_REWARD;
                    let currentAdsWatched = parseInt(localStorage.getItem('adsWatched')) + 1;
                    
                    localStorage.setItem('earnings', earnings.toString());
                    localStorage.setItem('adsWatched', currentAdsWatched.toString());
                    
                    tg.showAlert(`বিজ্ঞাপনটি দেখার জন্য আপনি BDT ${AD_REWARD.toFixed(2)} পেয়েছেন!`);
                }).catch(() => {
                    tg.showAlert('বিজ্ঞাপনটি দেখাতে সমস্যা হয়েছে। আবার চেষ্টা করুন।');
                }).finally(() => {
                    updateUI();
                });
            } else {
                // Fallback (Test mode)
                let earnings = parseFloat(localStorage.getItem('earnings')) + AD_REWARD;
                let currentAdsWatched = parseInt(localStorage.getItem('adsWatched')) + 1;
                localStorage.setItem('earnings', earnings.toString());
                localStorage.setItem('adsWatched', currentAdsWatched.toString());
                alert(`(Test Mode) You earned BDT ${AD_REWARD.toFixed(2)}!`);
                updateUI();
            }
        });

        withdrawForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('withdraw-amount').value);

            tg.showConfirm(`আপনি কি আপনার উইথড্র অনুরোধ জমা দিতে চান?`, (confirmed) => {
                if (confirmed) {
                    let newEarnings = parseFloat(localStorage.getItem('earnings')) - amount;
                    localStorage.setItem('earnings', newEarnings.toString());
                    withdrawForm.reset();
                    updateUI();
                    tg.showAlert('আপনার উইথড্র অনুরোধ সফলভাবে জমা হয়েছে।');
                }
            });
        });

        updateUI();
    });
            </script>
